@{
    Layout = null;
    var Keyid = "NewSchedulTable";
    var Message = ViewBag.Message;
    string NewSchedulDate = "";
    string NewSchedulTime = "";
    int DateCounts = 0;
    List<XYJHZX_MVC.Models.SchedulShowModel> Dates = ViewBag.SchedulDate;
    SelectList GroupList = ViewBag.GroupListDate;
    List<XYJHZX_MVC.Models.PatientModel> PatientList = ViewBag.PatientListDate;
    if (GroupList.SelectedValue == null)
    {
        GroupList.First().Selected = true;
    }
    List<string> arr_times = new List<string>();
    arr_times.Add("上午");
    arr_times.Add("下午");
    arr_times.Add("晚上");
    if (Dates != null)
    {
        DateCounts = Dates.Count();
        NewSchedulDate = Dates[0].SchedulDate;
        NewSchedulTime = Dates[0].SchedulTime;
        if(string.IsNullOrEmpty(NewSchedulDate))
        {
            NewSchedulDate = DateTime.Now.ToShortDateString().Replace('/','-');
        }
    }
    else
    {
        NewSchedulDate = DateTime.Now.ToShortDateString();
        NewSchedulTime = "上午";
    }
}

<script type="text/javascript">
    function SelectNewSchedulInf() {
        alert($('#txt_NewSchedulTime option:selected').val());
    }
    function SaveNewSchedulInf() {
        var _SchedulList = {};

        var trIndex = 0;
        var msg = "";
        $("#@Keyid tr:gt(0)").each(function () {
            var tr = $(this);

            var status = tr.children("td").eq(10).children("input").eq(0);
            if (status.val() == "1") {

                var mainid = tr.children("td").eq(8).children("input").eq(0);
                var SchedulDate = $("#txt_NewSchedulDate").val();
                var SchedulTime = $("#txt_NewSchedulTime").val();
                var patid = tr.children("td").eq(9).children("select").eq(0);
                var groupid = $("#txt_Group").val();
                var macid = tr.children("td").eq(7).children("input").eq(0);
                var dialyzerName = tr.children("td").eq(3).children("input").eq(0);
                var routeName = tr.children("td").eq(4).children("input").eq(0);
                var anticoagulantName = tr.children("td").eq(5).children("input").eq(0);
                var remark = tr.children("td").eq(6).children("input").eq(0);

                _SchedulList["arr_schedulList[" + trIndex + "].mainid"] = mainid.val();
                _SchedulList["arr_schedulList[" + trIndex + "].SchedulDate"] = SchedulDate;
                _SchedulList["arr_schedulList[" + trIndex + "].SchedulTime"] = SchedulTime;
                _SchedulList["arr_schedulList[" + trIndex + "].patid"] = patid.find("option:selected").text();
                _SchedulList["arr_schedulList[" + trIndex + "].groupid"] = groupid;
                _SchedulList["arr_schedulList[" + trIndex + "].macid"] = macid.val();
                _SchedulList["arr_schedulList[" + trIndex + "].dialyzerName"] = dialyzerName.val();
                _SchedulList["arr_schedulList[" + trIndex + "].routeName"] = routeName.val();
                _SchedulList["arr_schedulList[" + trIndex + "].anticoagulantName"] = anticoagulantName.val();
                _SchedulList["arr_schedulList[" + trIndex + "].remark"] = remark.val();
                _SchedulList["arr_schedulList[" + trIndex + "].status"] = status.val();

            }
            trIndex++;
        });

        $.ajax({
            type: "post",
            url: "/Schedul/SetSchedulMain",
            data: _SchedulList,
            async: true,
            traditional: true,
            beforeSend: function () {
                $('#NewSchedulDiv').empty().append("<h2>数据加载中。。。</h2>");
            },
            success: function () {
                location.reload(true);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("保存失败：" + errorThrown);
                location.reload(true);
            }
        });
    }
    function ClearNewSchedulRows(obj) {
        $("#PatName_" + obj).val('');
        $("#DialyzerName_" + obj).val('');
        $("#RouteName_" + obj).val('');
        $("#AnticoagulantName_" + obj).val('');
        $("#PatId_" + obj).val('');
        $("#SchedulStatus_" + obj).val('1');
    }
    function EditSchedulRows(obj) {
        $("#SchedulStatus_" + obj).val('1');
    }
</script>

<div id="NewSchedulDiv">
    <div>
        <ul>
            <li><label id="lab_NewSchedulDate" class="form-control-static">分组:</label></li>
            <li>@Html.DropDownList("txt_Group", GroupList, new { @class = "form-control", @style = "width:80px" })</li>
            <li><label id="lab_NewSchedulDate" class="form-control-static">日期:</label></li>
            <li><input id="txt_NewSchedulDate" type="text" class="form-control" style="width:100px" value="@NewSchedulDate" onclick="WdatePicker({ isShowWeek: true, isShowClear: false })" /></li>
            <li>@Html.DropDownList("txt_NewSchedulTime", new SelectList(arr_times, "上午"), new { @class = "form-control", @style = "width:80px" })</li>
            <li><input id="btn_NewSchedulSelect" class="btn-info" type="submit" value="查 询" onclick="SelectNewSchedulInf()" style="margin:3px;" /></li>
            <li><input id="btn_NewSchedulCopy" class="btn-info" type="submit" value="保 存" onclick="SaveNewSchedulInf()" style="margin:3px;" /></li>
        </ul>
    </div>

    <div style="overflow:scroll;width:550px;height:700px;">
        <table id="@Keyid" class="table table-striped table-bordered">
            <tr>
                <td></td>
                <td><div style="width:40px;">机号</div></td>
                <td><div style="width:60px;">姓名</div></td>
                <td><div style="width:80px;">透析器</div></td>
                <td><div style="width:60px;">路径</div></td>
                <td><div style="width:120px;">抗凝剂</div></td>
                <td><div style="width:100px;">备注</div></td>
            </tr>

            @if (Dates != null)
            {
                for (int i = 0; i < Dates.Count; i++)
                {
                    <tr id="PatientRows_@(i)">
                        <td><input class="btn-info" type="button" value="清 空" onclick="ClearNewSchedulRows(@(i))" style="margin:3px 20px 0 0;" /></td>
                        <td>@Html.Label("MacName_@i", @Dates[i].macname, new { @class = "form-inline", @style = "width:40px;" })</td>
                        <td>@Html.DropDownList("PatName_" + i, new SelectList(PatientList, "PatId", "PatName", Dates[i].patName + ""), new { @class = "form-control", @style = "width:100px", @onchange = "EditSchedulRows(" + (i) + ")" })</td>
                        <td>@Html.TextBox("DialyzerName_" + i, Dates[i].dialyzerName, new { @class = "form-control", @style = "width:100px", @onchange = "EditSchedulRows(" + (i) + ")" })</td>
                        <td>@Html.TextBox("RouteName_" + i, Dates[i].routeName, new { @class = "form-control", @style = "width:100px", @onchange = "EditSchedulRows(" + (i) + ")" })</td>
                        <td>@Html.TextBox("AnticoagulantName_" + i, Dates[i].anticoagulantName, new { @class = "form-control", @style = "width:100px", @onchange = "EditSchedulRows(" + (i) + ")" })</td>
                        <td>@Html.TextBox("Remark_" + i, Dates[i].remark, new { @class = "form-control", @style = "width:100px", @onchange = "EditSchedulRows(" + (i) + ")" })</td>
                        <td style="display:none"><input id="MacId_@(i)" name="MacId_@(i)" value="@Dates[i].macid" /></td>
                        <td style="display:none"><input id="MainId_@(i)" name="SendDeptId_@(i)" value="@Dates[i].mainid" /></td>
                        <td style="display:none"><input id="PatId_@(i)" name="SendDeptId_@(i)" value="@Dates[i].patid" /></td>
                        <td style="display:none"><input id="SchedulStatus_@(i)" value="0" /></td>
                    </tr>
                }
            }
            <tr>
                <td colspan="10">
                    共 @DateCounts 条记录
                </td>
            </tr>
        </table>
    </div>
</div>